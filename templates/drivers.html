{% extends "base.html" %}

{% block title %}Gestione Autisti - Sistema di Gestione e Valutazione Autisti{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="container">
        <div class="page-header-content">
            <h1 class="page-title">Elenco Autisti</h1>
            <button id="addDriverBtn" class="btn btn-primary">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Aggiungi Autista
            </button>
        </div>
    </div>
</div>

<!-- Drivers Content -->
<div class="drivers-content">
    <div class="container">
        <!-- Search and Filter Bar -->
        <div class="search-filter-bar">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Cerca autisti per nome..." class="search-input">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
            </div>
            
            <div class="filter-controls">
                <select id="classificationFilter" class="filter-select">
                    <option value="">Tutte le classificazioni</option>
                    <option value="Non Classificato">Non Classificato</option>
                    <option value="Principiante">Principiante</option>
                    <option value="Efficiente">Efficiente</option>
                    <option value="Esperto">Esperto</option>
                </select>
                
                <select id="statusFilter" class="filter-select">
                    <option value="">Tutti gli stati</option>
                    <option value="Offline">Offline</option>
                    <option value="Online">Online</option>
                    <option value="In Corso">In Corso</option>
                </select>
            </div>
        </div>

        <!-- Drivers Grid -->
        <div id="driversGrid" class="drivers-grid">
            <!-- Driver cards will be dynamically loaded here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state hidden">
            <div class="empty-state-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="8.5" cy="7" r="4"></circle>
                    <line x1="20" y1="8" x2="20" y2="14"></line>
                    <line x1="23" y1="11" x2="17" y2="11"></line>
                </svg>
            </div>
            <h3>Nessun autista trovato</h3>
            <p>Aggiungine uno per iniziare o modifica i filtri di ricerca.</p>
            <button class="btn btn-primary" onclick="openAddDriverModal()">
                Aggiungi il primo autista
            </button>
        </div>
    </div>
</div>

<!-- Add Driver Modal -->
<div id="addDriverModal" class="modal hidden">
    <div class="modal-overlay" onclick="closeAddDriverModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h2>Aggiungi Nuovo Autista</h2>
            <button class="modal-close" onclick="closeAddDriverModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        
        <form id="addDriverForm" class="modal-form">
            <div class="form-group">
                <label for="firstName" class="form-label">Nome *</label>
                <input type="text" id="firstName" name="firstName" class="form-input" required>
                <div class="form-error" id="firstNameError"></div>
            </div>
            
            <div class="form-group">
                <label for="lastName" class="form-label">Cognome *</label>
                <input type="text" id="lastName" name="lastName" class="form-input" required>
                <div class="form-error" id="lastNameError"></div>
            </div>
            
            <div class="form-group">
                <label for="simulationFile" class="form-label">File Simulazione (CSV) *</label>
                <div class="file-input-container">
                    <input type="file" id="simulationFile" name="simulationFile" accept=".csv" class="file-input" required>
                    <label for="simulationFile" class="file-input-label">
                        <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14,2 14,8 20,8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10,9 9,9 8,9"></polyline>
                        </svg>
                        <span id="fileLabel">Seleziona file CSV</span>
                    </label>
                </div>
                <div class="form-help">Solo file CSV sono accettati (max 16MB)</div>
                <div class="form-error" id="simulationFileError"></div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeAddDriverModal()">
                    Annulla
                </button>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <span id="submitText">Aggiungi Autista</span>
                    <span id="submitSpinner" class="submit-spinner hidden">
                        <div class="spinner-small"></div>
                        Aggiungendo...
                    </span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Driver Details Modal -->
<div id="driverDetailsModal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-content-large">
        <div class="modal-header">
            <h2>Dettagli Autista</h2>
            <button class="modal-close">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        
        <form id="updateDriverForm" class="modal-form">
            <div class="driver-details-grid">
                <!-- Left Column - Editable Fields -->
                <div class="driver-details-left">
                    <h3>Informazioni Modificabili</h3>
                    
                    <div class="form-group">
                        <label for="updateFirstName" class="form-label">Nome *</label>
                        <input type="text" id="updateFirstName" name="firstName" class="form-input" required>
                        <div class="form-error" id="updateFirstNameError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="updateLastName" class="form-label">Cognome *</label>
                        <input type="text" id="updateLastName" name="lastName" class="form-input" required>
                        <div class="form-error" id="updateLastNameError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="updateSimulationFile" class="form-label">Sostituisci File Simulazione (CSV)</label>
                        <div class="file-input-container">
                            <input type="file" id="updateSimulationFile" name="simulationFile" accept=".csv" class="file-input">
                            <label for="updateSimulationFile" class="file-input-label">
                                <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14,2 14,8 20,8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <polyline points="10,9 9,9 8,9"></polyline>
                                </svg>
                                <span id="updateFileLabel">Seleziona nuovo file CSV (opzionale)</span>
                            </label>
                        </div>
                        <div class="form-help">Lascia vuoto per mantenere il file attuale</div>
                        <div class="form-error" id="updateSimulationFileError"></div>
                    </div>
                </div>
                
                <!-- Right Column - Read-only Info -->
                <div class="driver-details-right">
                    <h3>Informazioni Correnti</h3>
                    
                    <div class="info-group">
                        <label class="info-label">ID Autista</label>
                        <span id="detailsDriverId" class="info-value">-</span>
                    </div>
                    
                    <div class="info-group">
                        <label class="info-label">Stato Monitoraggio</label>
                        <span id="detailsMonitoringStatus" class="info-value status-badge">-</span>
                    </div>
                    
                    <div class="info-group">
                        <label class="info-label">Classificazione</label>
                        <span id="detailsClassification" class="info-value classification-badge">-</span>
                    </div>
                    
                    <div class="info-group">
                        <label class="info-label">File Simulazione Attuale</label>
                        <span id="detailsSimulationFile" class="info-value file-info">-</span>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="closeDriverDetailsBtn">
                    Chiudi
                </button>
                <button type="button" class="btn btn-secondary" id="classifyDriverBtn">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"></polyline>
                    </svg>
                    <span class="classify-text">Classifica</span>
                    <span class="classify-spinner hidden">
                        <div class="spinner-small"></div>
                        Classificando...
                    </span>
                </button>
                <button type="submit" class="btn btn-primary" id="updateSubmitBtn">
                    <span id="updateSubmitText">Salva Modifiche</span>
                    <span id="updateSubmitSpinner" class="submit-spinner hidden">
                        <div class="spinner-small"></div>
                        Salvando...
                    </span>
                </button>
                <button type="button" class="btn btn-danger" id="deleteDriverBtn">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3,6 5,6 21,6"></polyline>
                        <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                    </svg>
                    Elimina Autista
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Driver Card Template (Hidden, used for cloning) -->
<template id="driverCardTemplate">
    <div class="driver-card">
        <div class="driver-card-header">
            <div class="driver-info">
                <h3 class="driver-name"></h3>
                <div class="driver-meta">
                    <span class="driver-id"></span>
                </div>
            </div>
            <div class="driver-status">
                <span class="status-indicator"></span>
                <span class="status-text"></span>
            </div>
        </div>
        
        <div class="driver-card-body">
            <div class="classification-badge">
                <span class="classification-text"></span>
            </div>
            
            <div class="driver-file-info">
                <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14,2 14,8 20,8"></polyline>
                </svg>
                <span class="file-name"></span>
            </div>
        </div>
        
        <div class="driver-card-actions">
            <a href="#" class="btn btn-primary btn-sm monitor-btn">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                </svg>
                Monitora
            </a>
        </div>
    </div>
</template>
{% endblock %}

{% block page_init_js %}
// Drivers page specific initialization
let driversData = [];
let filteredDrivers = [];

// Initialize drivers page
initializeDriversPage();

async function initializeDriversPage() {
    await loadDrivers();
    setupEventListeners();
    setupFormValidation();
}

function setupEventListeners() {
    // Add driver button
    document.getElementById('addDriverBtn').addEventListener('click', openAddDriverModal);
    
    // Search input
    document.getElementById('searchInput').addEventListener('input', filterDrivers);
    
    // Filter selects
    document.getElementById('classificationFilter').addEventListener('change', filterDrivers);
    document.getElementById('statusFilter').addEventListener('change', filterDrivers);
    
    // Add driver form submission
    document.getElementById('addDriverForm').addEventListener('submit', handleAddDriver);
    
    // Update driver form submission
    document.getElementById('updateDriverForm').addEventListener('submit', handleUpdateDriver);
    
    // File input changes
    document.getElementById('simulationFile').addEventListener('change', handleFileSelect);
    document.getElementById('updateSimulationFile').addEventListener('change', handleUpdateFileSelect);
    
    // Driver details modal actions
    document.getElementById('classifyDriverBtn').addEventListener('click', handleClassifyFromModal);
    document.getElementById('deleteDriverBtn').addEventListener('click', handleDeleteDriver);
    document.getElementById('closeDriverDetailsBtn').addEventListener('click', closeDriverDetailsModal);
    
    // Modal close buttons and overlay
    document.querySelector('#driverDetailsModal .modal-close').addEventListener('click', closeDriverDetailsModal);
    document.querySelector('#driverDetailsModal .modal-overlay').addEventListener('click', closeDriverDetailsModal);
}

async function loadDrivers() {
    try {
        showLoading(true);
        const response = await fetch('/api/drivers');
        const result = await response.json();
        
        if (result.success) {
            driversData = result.data;
            filteredDrivers = [...driversData];
            renderDrivers();
        } else {
            showFlashMessage('Errore nel caricamento degli autisti: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error loading drivers:', error);
        showFlashMessage('Errore di connessione durante il caricamento degli autisti', 'error');
    } finally {
        showLoading(false);
    }
}

function renderDrivers() {
    const grid = document.getElementById('driversGrid');
    const emptyState = document.getElementById('emptyState');
    
    if (filteredDrivers.length === 0) {
        grid.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
    }
    
    grid.classList.remove('hidden');
    emptyState.classList.add('hidden');
    
    // Clear existing cards
    grid.innerHTML = '';
    
    // Create driver cards
    filteredDrivers.forEach(driver => {
        const card = createDriverCard(driver);
        grid.appendChild(card);
    });
}

function createDriverCard(driver) {
    const template = document.getElementById('driverCardTemplate');
    const card = template.content.cloneNode(true);
    
    // Set driver data
    card.querySelector('.driver-name').textContent = `${driver.firstName} ${driver.lastName}`;
    card.querySelector('.driver-id').textContent = `ID: ${driver.id}`;
    
    // Set status
    const statusIndicator = card.querySelector('.status-indicator');
    const statusText = card.querySelector('.status-text');
    statusIndicator.className = `status-indicator status-${driver.monitoringStatus.toLowerCase().replace(' ', '-')}`;
    statusText.textContent = driver.monitoringStatus;
    
    // Set classification
    const classificationBadge = card.querySelector('.classification-badge');
    const classificationText = card.querySelector('.classification-text');
    classificationText.textContent = driver.classification;
    classificationBadge.className = `classification-badge classification-${driver.classification.toLowerCase().replace(' ', '-')}`;
    
    // Set file info
    card.querySelector('.file-name').textContent = driver.simulationFile || 'Nessun file';
    
    // Set up action buttons
    const monitorBtn = card.querySelector('.monitor-btn');
    monitorBtn.href = `/monitor/${driver.id}`;
    
    // Store driver ID on card element and make it clickable
    const cardElement = card.querySelector('.driver-card');
    cardElement.dataset.driverId = driver.id;
    cardElement.classList.add('driver-card-clickable');
    
    // Add click event to open details modal (but not on monitor button)
    cardElement.addEventListener('click', (event) => {
        // Don't open modal if clicking on the monitor button
        if (!event.target.closest('.monitor-btn')) {
            openDriverDetailsModal(driver.id);
        }
    });
    
    return card;
}

function filterDrivers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const classificationFilter = document.getElementById('classificationFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    filteredDrivers = driversData.filter(driver => {
        const matchesSearch = !searchTerm || 
            `${driver.firstName} ${driver.lastName}`.toLowerCase().includes(searchTerm);
        
        const matchesClassification = !classificationFilter || 
            driver.classification === classificationFilter;
        
        const matchesStatus = !statusFilter || 
            driver.monitoringStatus === statusFilter;
        
        return matchesSearch && matchesClassification && matchesStatus;
    });
    
    renderDrivers();
}

function openAddDriverModal() {
    document.getElementById('addDriverModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeAddDriverModal() {
    document.getElementById('addDriverModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    
    // Reset form
    document.getElementById('addDriverForm').reset();
    clearFormErrors();
    document.getElementById('fileLabel').textContent = 'Seleziona file CSV';
}

// Make functions globally available for onclick handlers
window.openAddDriverModal = openAddDriverModal;
window.closeAddDriverModal = closeAddDriverModal;

function handleFileSelect(event) {
    const file = event.target.files[0];
    const label = document.getElementById('fileLabel');
    
    if (file) {
        label.textContent = file.name;
    } else {
        label.textContent = 'Seleziona file CSV';
    }
}

async function handleAddDriver(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    // Clear previous errors
    clearFormErrors();
    
    // Update submit button state
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const submitSpinner = document.getElementById('submitSpinner');
    
    submitText.classList.add('hidden');
    submitSpinner.classList.remove('hidden');
    submitBtn.disabled = true;
    
    try {
        const response = await fetch('/api/drivers', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showFlashMessage(result.message || 'Autista aggiunto con successo', 'success');
            closeAddDriverModal();
            await loadDrivers(); // Reload the drivers list
        } else {
            showFlashMessage('Errore: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error adding driver:', error);
        showFlashMessage('Errore di connessione durante l\'aggiunta dell\'autista', 'error');
    } finally {
        // Reset submit button state
        submitText.classList.remove('hidden');
        submitSpinner.classList.add('hidden');
        submitBtn.disabled = false;
    }
}

function setupFormValidation() {
    const form = document.getElementById('addDriverForm');
    const inputs = form.querySelectorAll('input[required]');
    
    inputs.forEach(input => {
        input.addEventListener('blur', validateField);
        input.addEventListener('input', clearFieldError);
    });
}

function validateField(event) {
    const field = event.target;
    const value = field.value.trim();
    
    switch (field.name) {
        case 'firstName':
        case 'lastName':
            if (!value) {
                showFieldError(field.name, 'Questo campo è obbligatorio');
            } else if (value.length < 2) {
                showFieldError(field.name, 'Deve contenere almeno 2 caratteri');
            }
            break;
        case 'simulationFile':
            if (!field.files[0]) {
                showFieldError(field.name, 'Seleziona un file CSV');
            }
            break;
    }
}

function showFieldError(fieldName, message) {
    const errorElement = document.getElementById(fieldName + 'Error');
    if (errorElement) {
        errorElement.textContent = message;
        errorElement.classList.add('visible');
    }
}

function clearFieldError(event) {
    const fieldName = event.target.name;
    const errorElement = document.getElementById(fieldName + 'Error');
    if (errorElement) {
        errorElement.textContent = '';
        errorElement.classList.remove('visible');
    }
}

function clearFormErrors() {
    const errorElements = document.querySelectorAll('.form-error');
    errorElements.forEach(element => {
        element.textContent = '';
        element.classList.remove('visible');
    });
}

// ===== DRIVER DETAILS MODAL FUNCTIONS =====

let currentDriverData = null;

async function openDriverDetailsModal(driverId) {
    try {
        // Fetch current driver data
        const response = await fetch(`/api/drivers/${driverId}`);
        const result = await response.json();
        
        if (result.success) {
            currentDriverData = result.data;
            populateDriverDetails(result.data);
            document.getElementById('driverDetailsModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        } else {
            showFlashMessage('Errore nel caricamento dei dettagli: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error loading driver details:', error);
        showFlashMessage('Errore di connessione durante il caricamento dei dettagli', 'error');
    }
}

function closeDriverDetailsModal() {
    document.getElementById('driverDetailsModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    
    // Reset form
    document.getElementById('updateDriverForm').reset();
    clearFormErrors();
    document.getElementById('updateFileLabel').textContent = 'Seleziona nuovo file CSV (opzionale)';
    currentDriverData = null;
}

function populateDriverDetails(driver) {
    // Populate editable fields
    document.getElementById('updateFirstName').value = driver.firstName;
    document.getElementById('updateLastName').value = driver.lastName;
    
    // Populate read-only info
    document.getElementById('detailsDriverId').textContent = driver.id;
    
    const statusBadge = document.getElementById('detailsMonitoringStatus');
    statusBadge.textContent = driver.monitoringStatus;
    statusBadge.className = `info-value status-badge status-${driver.monitoringStatus.toLowerCase().replace(' ', '-')}`;
    
    const classificationBadge = document.getElementById('detailsClassification');
    classificationBadge.textContent = driver.classification;
    classificationBadge.className = `info-value classification-badge classification-${driver.classification.toLowerCase().replace(' ', '-')}`;
    
    document.getElementById('detailsSimulationFile').textContent = driver.simulationFile || 'Nessun file';
}

function handleUpdateFileSelect(event) {
    const file = event.target.files[0];
    const label = document.getElementById('updateFileLabel');
    
    if (file) {
        label.textContent = file.name;
    } else {
        label.textContent = 'Seleziona nuovo file CSV (opzionale)';
    }
}

async function handleUpdateDriver(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    // Clear previous errors
    clearFormErrors();
    
    // Update submit button state
    const submitBtn = document.getElementById('updateSubmitBtn');
    const submitText = document.getElementById('updateSubmitText');
    const submitSpinner = document.getElementById('updateSubmitSpinner');
    
    submitText.classList.add('hidden');
    submitSpinner.classList.remove('hidden');
    submitBtn.disabled = true;
    
    try {
        const response = await fetch(`/api/drivers/${currentDriverData.id}`, {
            method: 'PUT',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showFlashMessage(result.message || 'Autista aggiornato con successo', 'success');
            closeDriverDetailsModal();
            await loadDrivers(); // Reload the drivers list
        } else {
            showFlashMessage('Errore: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error updating driver:', error);
        showFlashMessage('Errore di connessione durante l\'aggiornamento dell\'autista', 'error');
    } finally {
        // Reset submit button state
        submitText.classList.remove('hidden');
        submitSpinner.classList.add('hidden');
        submitBtn.disabled = false;
    }
}

async function handleClassifyFromModal() {
    if (!currentDriverData) return;
    
    const button = document.getElementById('classifyDriverBtn');
    const classifyText = button.querySelector('.classify-text');
    const classifySpinner = button.querySelector('.classify-spinner');
    
    try {
        // Update button state
        classifyText.classList.add('hidden');
        classifySpinner.classList.remove('hidden');
        button.disabled = true;
        
        const response = await fetch(`/api/drivers/${currentDriverData.id}/classify`);
        const result = await response.json();
        
        if (result.success) {
            showFlashMessage(`Classificazione completata: ${result.data.classification}`, 'success');
            
            // Update the classification display in the modal
            const classificationBadge = document.getElementById('detailsClassification');
            classificationBadge.textContent = result.data.classification;
            classificationBadge.className = `info-value classification-badge classification-${result.data.classification.toLowerCase().replace(' ', '-')}`;
            
            // Update current driver data
            currentDriverData.classification = result.data.classification;
            
            // Reload drivers list to reflect changes
            await loadDrivers();
        } else {
            showFlashMessage('Errore nella classificazione: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error classifying driver:', error);
        showFlashMessage('Errore di connessione durante la classificazione', 'error');
    } finally {
        // Reset button state
        classifyText.classList.remove('hidden');
        classifySpinner.classList.add('hidden');
        button.disabled = false;
    }
}

async function handleDeleteDriver() {
    if (!currentDriverData) return;
    
    // Confirm deletion
    const confirmed = confirm(`Sei sicuro di voler eliminare l'autista ${currentDriverData.firstName} ${currentDriverData.lastName}?\n\nQuesta azione non può essere annullata.`);
    
    if (!confirmed) return;
    
    const button = document.getElementById('deleteDriverBtn');
    
    try {
        button.disabled = true;
        button.textContent = 'Eliminando...';
        
        const response = await fetch(`/api/drivers/${currentDriverData.id}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showFlashMessage(result.message || 'Autista eliminato con successo', 'success');
            closeDriverDetailsModal();
            await loadDrivers(); // Reload the drivers list
        } else {
            showFlashMessage('Errore nell\'eliminazione: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error deleting driver:', error);
        showFlashMessage('Errore di connessione durante l\'eliminazione dell\'autista', 'error');
    } finally {
        button.disabled = false;
        button.innerHTML = `
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3,6 5,6 21,6"></polyline>
                <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
            </svg>
            Elimina Autista
        `;
    }
}
{% endblock %}